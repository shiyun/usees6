
<!DOCTYPE html>
<html>
<head>
    <!--[if lt IE 9]>
		<script type="text/javascript" src="js/html5.js"></script>
		<![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title></title>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/global.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script type="text/javascript" src="js/main.js"></script>
 
    <!--plugin-->
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="style/base.css">
    <link rel="stylesheet" type="text/css" href="style/index.css">
 
</head>

<body>
    <!-------------------------------------- 内容开始 -------------------------------------->
    <section class="line"></section>
      
    <section class="mainer faxian">
        <section class="wrap">
            
             <section class="sec-list" >
                 <section class="page waterfull clearfloat" id="waterfull">
                     <ul id="waterfullWrap">
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img1.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">COCOCITY</a></div>
                                 <div class="zan"><span>399</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img2.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">海底捞书香门第店</a></div>
                                 <div class="zan"><span class="on">30</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img3.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">显示具体地方</a></div>
                                 <div class="zan"><span>129</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/t10.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">不要显示城市名</a></div>
                                 <div class="zan"><span class="on">19</span></div>
                             </section>
                         </li>
                         <li class="item">

                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img1.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">COCOCITY</a></div>
                                 <div class="zan"><span>399</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img2.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">海底捞书香门第店</a></div>
                                 <div class="zan"><span class="on">30</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img3.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">显示具体地方</a></div>
                                 <div class="zan"><span>129</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img4.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">不要显示城市名</a></div>
                                 <div class="zan"><span class="on">19</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img4.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">不要显示城市名</a></div>
                                 <div class="zan"><span class="on">19</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/img4.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">不要显示城市名</a></div>
                                 <div class="zan"><span class="on">19</span></div>
                             </section>
                         </li>
                         <li class="item">
                             <section class="img"><a href="app-发现-图片-浏览2.html"><img src="img/t8.jpg" /></a></section>
                             <section class="text">
                                 <div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div>
                                 <div class="head-name"><a href="#">不要显示城市名</a></div>
                                 <div class="zan"><span class="on">19</span></div>
                             </section>
                         </li>
                          
                     </ul>
                 </section>
                 <div id="imloading" style="width:150px;height:30px;line-height:30px;font-size:16px;text-align:center;border-radius:3px;opacity:0.7;background:#000;margin:10px auto 30px;color:#fff;display:none">
                     加载中.....
                 </div>
             </section>
        </section>
    </section>
    <!-------------------------------------- 内容结束 -------------------------------------->
    <!-------------------------------------- 尾部开始 -------------------------------------->
    
    <!-------------------------------------- 尾部结束 -------------------------------------->
    <script type="text/javascript" src="js/jQueryColor.js"></script>
    <!--这个插件是瀑布流主插件函数必须-->
    <script type="text/javascript" src="js/jquery.masonry.min.js"></script>
    <!--这个插件只是为了扩展jquery的animate函数动态效果可有可无-->
    <script type="text/javascript" src="js/jQeasing.js"></script>
    <script type="text/javascript" src="js/dropload.js"></script>
    <script type="text/javascript">

		var sqlJson = [{ 'title': '海底捞书香门第店', 'zan': '20', 'src': 'img/t10.jpg' }, { 'title': '海底捞书香门第店', 'zan': '10', 'src': 'img/t8.jpg' }, { 'title': '海底捞书香门第店', 'zan': '0', 'src': 'img/img1.jpg' }, { 'title': '海底捞书香门第店', 'zan': '20', 'src': 'img/t10.jpg' }, { 'title': '海底捞书香门第店', 'zan': '10', 'src': 'img/t8.jpg' }, { 'title': '海底捞书香门第店', 'zan': '0', 'src': 'img/img1.jpg' } ];
	
		var waterfall = {
			isOver		: false,
			container	: $('#waterfull'),
			wrapper		: $('#waterfullWrap'),
			loading		: $('#imloading'),
			wW			: $(window).width(),
			tmpWid		: $(window).width(),
			wt			: parseInt($(window).width()/2),
			resetWid	: function(){
				var that = this;
				var column=Math.floor(that.tmpWid/that.wt);
				that.tmpWid = that.tmpWid > 1280 ? 1280 : column*that.wt;
				that.wrapper.width(that.tmpWid);
				that.loading.data("on",true);
			},
			imgLoaded	: function(){
				var that = this;

				that.wrapper.imagesLoaded(function(){
				  that.wrapper.masonry({
				  	columnWidth: that.wt,
				    itemSelector : '.item',
				    isFitWidth: true,//是否根据浏览器窗口大小自动适应默认false
				    isAnimated: false,//是否采用jquery动画进行重拍版
				    isRTL:false,//设置布局的排列方式，即：定位砖块时，是从左向右排列还是从右向左排列。默认值为false，即从左向右
				    isResizable: true,//是否自动布局默认true
				    animationOptions: {
						duration: 800,
						easing: 'easeInOutBack',//如果你引用了jQeasing这里就可以添加对应的动态动画效果，如果没引用删除这行，默认是匀速变化
						queue: false//是否队列，从一点填充瀑布流
					}
				  });
				});
			},
			dropload	: function(){
				var that = this;
				that.container.dropload({
					scrollArea: window,
					domUp: {
						domClass: 'dropload-up',
						domRefresh: '<div class="dropload-refresh">↓下拉刷新</div>',
						domUpdate: '<div class="dropload-update">↑释放更新</div>',
						domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>'
					},
					domDown: {
						domClass: 'dropload-down',
						domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
						domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>',
						domNoData: '<div class="dropload-noData">暂无数据</div>'
					},
					loadUpFn: function (me) {
						setTimeout(function () { window.location.reload() }, 1000);
					},
					loadDownFn: function (me) {
						setTimeout(function () {
							that.scroll();
							me.resetload();
							if(that.isOver){
								that.container.find('.dropload-refresh').text('我是有底线的！');
							}
						});
						
					},
					threshold: 50,
					distance: 100
				});

			},			
			loadImage	: function(url){
				var img = new Image();
				img.src = url;
				if (img.complete) {
					return img.src;
				}
				img.onload = function () {
					return img.src;
				};
			},
			scroll		: function(){
				var that = this;
				if(!that.loading.data("on")) return;
				// 计算所有瀑布流块中距离顶部最大，进而在滚动条滚动时，来进行ajax请求，方法很多这里只列举最简单一种，最易理解一种
				var itemNum= that.wrapper.find('li').length;
				var itemArr = [];

				itemArr[0]=that.wrapper.find('li').eq(itemNum-1).offset().top+that.wrapper.find('li').eq(itemNum-1).height();
				itemArr[1]=that.wrapper.find('li').eq(itemNum-2).offset().top+that.wrapper.find('li').eq(itemNum-1).height();
				itemArr[2]=that.wrapper.find('li').eq(itemNum-3).offset().top+that.wrapper.find('li').eq(itemNum-1).height();
				var maxTop=Math.max.apply(null,itemArr);
				//if(maxTop<$(window).height()+$(document).scrollTop()){
					//加载更多数据
					that.loading.data("on",false);//.fadeIn(800);
					(function(sqlJson){
						//这里会根据后台返回的数据来判断是否你进行分页或者数据加载完毕这里假设大于30就不在加载数据
						if(itemNum>30){
							that.isOver = true;							
						}else{
							var html="";
							for (var i in sqlJson) { 
								html += "<li class='item'><a href='app-发现-图片-浏览2.html' class='a-img'><img src='" + sqlJson[i].src + "'></a>";
								html += '<section class="text"><div class="head-pic"><section class="img"><img src="img/pic1.png" /></section></div><div class="head-name"><a href="#">' + sqlJson[i].title + '</a></div><div class="zan"><span class="on">'+sqlJson[i].zan+'</span></div></section></li>';
								
							}
							//模拟ajax请求数据时延时400毫秒
							var time=setTimeout(function(){
								$(html).find('img').each(function(index){
									that.loadImage($(this).attr('src'));
								})
								var $newElems = $(html).css({ opacity: 0}).appendTo(that.wrapper);
								$newElems.imagesLoaded(function(){
									$newElems.animate({ opacity: 1},800);
									that.wrapper.masonry( 'appended', $newElems,true);
									that.loading.data("on",true).fadeOut();
									clearTimeout(time);
								});
							},200)
						}
					})(sqlJson);
				//}
			},
			init		: function(){
				var that = this;
				that.resetWid();
				that.imgLoaded();
				for(var i=0; i<6; i++){
					(function(a){
						that.wrapper.find('li:eq('+a+')').find('>.img img').on('load', function(){
							if(a === 5){
								that.dropload();								
							}
						});
					})(i)
				}								
			}
		};

		waterfall.init();

		
    </script>
</body>
    
</html>